{% extends "admin/base.html" %}

{% block title %}スクレイピングタスク管理{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>スクレイピングタスク管理</h2>
    <div>
        {# ▼▼▼ 新規タスク追加ボタン ▼▼▼ #}
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addTaskModal">
            <i class="bi bi-plus-circle"></i> 新規タスク追加
        </button>
        <a href="{{ url_for('generate_gmap_tasks') }}" class="btn btn-success">
            <i class="bi bi-google"></i> Google Mapタスクを自動生成
        </a>
    </div>
</div>

<p>各エリアURLのスクレイピングを実行・管理します。</p>


{# ===== 絞り込み・検索フォーム ===== #}
<div class="card bg-dark border-secondary mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('scraping_tasks') }}">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="task_type" class="form-label">種類</label>
                    <select id="task_type" name="task_type" class="form-select">
                        <option value="">すべて</option>
                        <option value="GMAP" {% if filters.task_type == 'GMAP' %}selected{% endif %}>GMAP</option>
                        <option value="HPB" {% if filters.task_type == 'HPB' %}selected{% endif %}>HPB</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="prefecture" class="form-label">都道府県</label>
                    <select id="prefecture" name="prefecture" class="form-select">
                        <option value="">すべて</option>
                        {% for pref in prefectures %}
                        <option value="{{ pref }}" {% if filters.prefecture == pref %}selected{% endif %}>{{ pref }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">ステータス</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">すべて</option>
                        {% for st in task_statuses %}
                        <option value="{{ st }}" {% if filters.status == st %}selected{% endif %}>{{ st }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="category_id" class="form-label">カテゴリ</label>
                    <select id="category_id" name="category_id" class="form-select">
                        <option value="">すべて</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if filters.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">最終実行日</label>
                    <div class="input-group">
                        <input type="date" name="start_date" class="form-control" value="{{ filters.start_date }}">
                        <span class="input-group-text">～</span>
                        <input type="date" name="end_date" class="form-control" value="{{ filters.end_date }}">
                    </div>
                </div>

                <div class="col-md-2">
                    <label for="search_id" class="form-label">ID検索</label>
                    <input type="text" id="search_id" name="search_id" class="form-control" placeholder="IDで検索" value="{{ filters.search_id }}">
                </div>
                 <div class="col-md-4">
                    <label for="search_keyword" class="form-label">キーワード検索</label>
                    <input type="text" id="search_keyword" name="search_keyword" class="form-control" placeholder="住所・キーワード" value="{{ filters.search_keyword }}">
                </div>

                <div class="col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2"><i class="bi bi-search"></i> 絞り込み</button>
                    <a href="{{ url_for('scraping_tasks') }}" class="btn btn-secondary"><i class="bi bi-x-lg"></i> リセット</a>
                </div>
            </div>
        </form>
    </div>
</div>


{# ===== タスク一覧テーブル ===== #}
<div class="table-responsive">
    <table class="table table-dark table-striped table-hover">
<thead>
    <tr>
        <th>ID</th>
        <th>種類</th>
        <th>カテゴリ</th>
        <th>ターゲット (URL / キーワード)</th>
        <th>ステータス</th>
<th>
    最終実行日時
    {# ▼▼▼ アイコンのクラスを追加 ▼▼▼ #}
    {% set asc_args = request.args.to_dict() %}
    {% set _ = asc_args.update({'sort_order': 'asc'}) %}
    <a href="{{ url_for('scraping_tasks', **asc_args) }}"><i class="bi bi-arrow-up"></i></a>

    {% set desc_args = request.args.to_dict() %}
    {% set _ = desc_args.update({'sort_order': 'desc'}) %}
    <a href="{{ url_for('scraping_tasks', **desc_args) }}"><i class="bi bi-arrow-down"></i></a>
    {# ▲▲▲ アイコンのクラスを追加 ▲▲▲ #}
</th>        <th class="text-center">実行</th>
    </tr>
</thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td><span class="badge {{ 'bg-success' if task.task_type == 'GMAP' else 'bg-danger' }}">{{ task.task_type }}</span></td>
                <td><span class="badge bg-secondary fw-normal">{{ task.category_name }}</span></td>
                <td class="text-break" style="max-width: 400px;">{{ task.target_url or task.search_keyword }}</td>
                <td>
                    {% if task.status == '完了' %}
                        <span class="badge bg-info">{{ task.status }}</span>
                    {% elif task.status == '失敗' %}
                         <span class="badge bg-warning text-dark">{{ task.status }}</span>
                    {% elif task.status == '実行中' %}
                         <span class="badge bg-primary">{{ task.status }}</span>
                    {% else %}
                        {{ task.status }}
                    {% endif %}
                </td>
                <td>{{ task.last_run_at.strftime('%Y-%m-%d %H:%M') if task.last_run_at else 'N/A' }}</td>
                <td class="text-center">
                    <div class="btn-group">
                        <a href="{{ url_for('run_task', task_id=task.id, update_mode='skip') }}" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" data-bs-title="重複スキップで実行">
                            <i class="bi bi-play-circle"></i>
                        </a>
                        <!-- <a href="{{ url_for('run_task', task_id=task.id, update_mode='overwrite') }}" class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" data-bs-title="上書きモードで実行">
                            <i class="bi bi-arrow-clockwise"></i>
                        </a>-->
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center">条件に一致するタスクはありません。</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- templates/admin/tasks.html -->

    <!-- ... (既存のテーブル表示) ... -->
    </table>
</div>

<!-- ▼▼▼ ページネーションのリンクを追加 ▼▼▼ -->
<nav aria-label="タスクページナビゲーション">
    <ul class="pagination justify-content-center">
        <!-- 前へ のリンク -->
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('scraping_tasks', page=pagination.prev_num) }}">前へ</a>
        </li>

        <!-- ページ番号のリンク (多すぎる場合は一部省略) -->
        {% for p_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=3) %}
            {% if p_num %}
                {% if p_num == pagination.page %}
                    <li class="page-item active" aria-current="page">
                        <span class="page-link">{{ p_num }}</span>
                    </li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('scraping_tasks', page=p_num) }}">{{ p_num }}</a>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
        {% endfor %}

        <!-- 次へ のリンク -->
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('scraping_tasks', page=pagination.next_num) }}">次へ</a>
        </li>
    </ul>
</nav>

<!-- ... (手動追加フォームのJavaScript) ... -->

{# ===== ▼▼▼ 新規タスク追加用モーダル ▼▼▼ ===== #}
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="addTaskModalLabel">新規タスク追加</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('scraping_tasks') }}" id="addTaskForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalTaskType" class="form-label">タスク種類*</label>
                        <select class="form-select" id="modalTaskType" name="task_type" required>
                            <option value="GMAP" selected>Google Map (キーワード検索)</option>
                            <option value="HPB">ホットペッパー (エリアURL)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modalCategory" class="form-label">カテゴリ*</label>
                        <select class="form-select" id="modalCategory" name="category_id" required>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="gmap_field" class="mb-3">
                        <label for="modalSearchKeyword" class="form-label">検索キーワード*</label>
                        <input type="text" class="form-control" id="modalSearchKeyword" name="search_keyword" placeholder="例: 東京都新宿区 美容院">
                    </div>

                    <div id="hpb_field" class="mb-3" style="display: none;">
                        <label for="modalTargetUrl" class="form-label">エリアURL*</label>
                        <input type="url" class="form-control" id="modalTargetUrl" name="target_url" placeholder="https://beauty.hotpepper.jp/...">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="submit" class="btn btn-primary">登録する</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}	

{% block scripts %}
<script>
// モーダル内のタスク種類に応じて、入力フィールドを切り替える
document.getElementById('modalTaskType').addEventListener('change', function() {
    const gmapField = document.getElementById('gmap_field');
    const hpbField = document.getElementById('hpb_field');
    const keywordInput = document.getElementById('modalSearchKeyword');
    const urlInput = document.getElementById('modalTargetUrl');

    if (this.value === 'GMAP') {
        gmapField.style.display = 'block';
        keywordInput.required = true;
        hpbField.style.display = 'none';
        urlInput.required = false;
    } else {
        gmapField.style.display = 'none';
        keywordInput.required = false;
        hpbField.style.display = 'block';
        urlInput.required = true;
    }
});
// 初期表示のために一度実行
document.getElementById('modalTaskType').dispatchEvent(new Event('change'));
</script>
{% endblock %}
