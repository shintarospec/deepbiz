{% extends "admin/base.html" %}

{% block title %}ä¼æ¥­åˆ†æãƒ†ã‚¹ãƒˆ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ğŸ§ª ä¼æ¥­åˆ†æãƒ†ã‚¹ãƒˆ</h2>
    <p class="text-muted">Gemini AIã‚’ä½¿ç”¨ã—ãŸä¼æ¥­åˆ†ææ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>

    <div class="card mt-4">
        <div class="card-header">
            <h5>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h5>
        </div>
        <div class="card-body">
            <form id="analysisForm">
                <div class="mb-3">
                    <label for="companyUrl" class="form-label">ä¼æ¥­ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURL</label>
                    <input type="url" 
                           class="form-control" 
                           id="companyUrl" 
                           placeholder="https://www.example.co.jp/"
                           value="https://www.cyberagent.co.jp/"
                           required>
                    <small class="form-text text-muted">åˆ†æã—ãŸã„ä¼æ¥­ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small>
                </div>
                
                <div class="mb-3">
                    <label for="sampleText" class="form-label">ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <textarea class="form-control" 
                              id="sampleText" 
                              rows="6"
                              placeholder="ä¼æ¥­æƒ…å ±ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç©ºæ¬„ã®å ´åˆã¯URLã‹ã‚‰è‡ªå‹•ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼‰">ã‚µã‚¤ãƒãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ ªå¼ä¼šç¤¾
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆåºƒå‘Šäº‹æ¥­
ãƒ¡ãƒ‡ã‚£ã‚¢äº‹æ¥­
ã‚²ãƒ¼ãƒ äº‹æ¥­
æŠ•è³‡è‚²æˆäº‹æ¥­

ä¼æ¥­ç†å¿µï¼š21ä¸–ç´€ã‚’ä»£è¡¨ã™ã‚‹ä¼šç¤¾ã‚’å‰µã‚‹
ãƒ“ã‚¸ãƒ§ãƒ³ï¼šæ–°ã—ã„æœªæ¥ã®ãƒ†ãƒ¬ãƒ“ã€ŒABEMAã€</textarea>
                    <small class="form-text text-muted">ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã§ãã¾ã™ã€‚ç©ºæ¬„ã®å ´åˆã¯URLã‹ã‚‰ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚</small>
                </div>

                <button type="submit" class="btn btn-primary" id="analyzeBtn">
                    <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
                    åˆ†æé–‹å§‹
                </button>
            </form>
        </div>
    </div>

    <div class="card mt-4 d-none" id="resultCard">
        <div class="card-header bg-success text-white">
            <h5>âœ… åˆ†æçµæœ</h5>
        </div>
        <div class="card-body">
            <div id="resultContent"></div>
        </div>
    </div>

    <div class="alert alert-danger mt-4 d-none" id="errorAlert">
        <strong>ã‚¨ãƒ©ãƒ¼:</strong> <span id="errorMessage"></span>
    </div>
</div>

<style>
    .analysis-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
    }
    .analysis-section h6 {
        color: #007bff;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .badge-custom {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .cost-info {
        background-color: #e7f3ff;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
    }
</style>

<script>
document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    const spinner = document.getElementById('spinner');
    const resultCard = document.getElementById('resultCard');
    const errorAlert = document.getElementById('errorAlert');
    const resultContent = document.getElementById('resultContent');
    
    // UIåˆæœŸåŒ–
    analyzeBtn.disabled = true;
    spinner.classList.remove('d-none');
    resultCard.classList.add('d-none');
    errorAlert.classList.add('d-none');
    
    const companyUrl = document.getElementById('companyUrl').value;
    const sampleText = document.getElementById('sampleText').value.trim();
    
    try {
        const response = await fetch('/admin/test_company_analysis_api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: companyUrl,
                sample_text: sampleText || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // çµæœè¡¨ç¤º
            const result = data.data;
            let html = '';
            
            // äº‹æ¥­å†…å®¹
            html += `
                <div class="analysis-section">
                    <h6>ğŸ“‹ äº‹æ¥­å†…å®¹</h6>
                    <p>${result.businessDescription || 'N/A'}</p>
                </div>
            `;
            
            // æ¥­ç•Œ
            html += `
                <div class="analysis-section">
                    <h6>ğŸ¢ æ¥­ç•Œ</h6>
                    <p><strong>${result.industry || 'N/A'}</strong></p>
                </div>
            `;
            
            // ä¼æ¥­è¦æ¨¡
            html += `
                <div class="analysis-section">
                    <h6>ğŸ“Š ä¼æ¥­è¦æ¨¡</h6>
                    <p><strong>${result.companySize || 'N/A'}</strong></p>
                </div>
            `;
            
            // å¼·ã¿
            if (result.strengths && result.strengths.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h6>ğŸ’ª å¼·ã¿</h6>
                        <ul>
                            ${result.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¡§å®¢
            html += `
                <div class="analysis-section">
                    <h6>ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¡§å®¢</h6>
                    <p>${result.targetCustomers || 'N/A'}</p>
                </div>
            `;
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            if (result.keyTopics && result.keyTopics.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h6>ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h6>
                        <div>
                            ${result.keyTopics.map(k => `<span class="badge bg-primary badge-custom">${k}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // èª²é¡Œ
            if (result.painPoints && result.painPoints.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h6>â— æ¨å®šã•ã‚Œã‚‹èª²é¡Œ</h6>
                        <ul>
                            ${result.painPoints.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // ã‚³ã‚¹ãƒˆæƒ…å ±
            const tokensUsed = data.tokens_used;
            const cost = data.cost;
            html += `
                <div class="cost-info">
                    <h6>ğŸ’° ã‚³ã‚¹ãƒˆæƒ…å ±</h6>
                    <p><strong>ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡:</strong> ${tokensUsed.total} ãƒˆãƒ¼ã‚¯ãƒ³ (å…¥åŠ›: ${tokensUsed.input}, å‡ºåŠ›: ${tokensUsed.output})</p>
                    <p><strong>å®Ÿè¡Œã‚³ã‚¹ãƒˆ:</strong> Â¥${cost.toFixed(6)} (ç´„${(cost * 1000).toFixed(3)}å††/1000ç¤¾)</p>
                </div>
            `;
            
            resultContent.innerHTML = html;
            resultCard.classList.remove('d-none');
        } else {
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            document.getElementById('errorMessage').textContent = data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            errorAlert.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('errorMessage').textContent = error.message;
        errorAlert.classList.remove('d-none');
    } finally {
        analyzeBtn.disabled = false;
        spinner.classList.add('d-none');
    }
});
</script>
{% endblock %}
