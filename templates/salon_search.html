{% extends "layout.html" %}
{% block title %}サロン検索 - Salondb{% endblock %}

{% block styles %}
  <style>
 </style>
{% endblock %}

{% block content %}
<div id="salonSearchContainer">
    <h1>サロン検索</h1>

    <form class="search-form" method="get" action="{{ url_for('salon_search') }}">
      <div class="search-form-row">
        <div class="search-form-item">
          <div class="custom-select-wrapper">
            <select name="area" class="form-select custom-select-override">
                <option value="">すべてのエリア</option>
                {% for area in area_options %}
                    <option value="{{ area }}" {% if area == selected_area %}selected{% endif %}>{{ area }}</option>
                {% endfor %}
            </select>
          </div>
        </div>
        <div class="search-form-item">
          <div class="custom-select-wrapper">
              <select name="category" class="form-select custom-select-override">
                  <option value="">すべてのカテゴリ</option>
                  {% for cat in all_categories %}
                      <option value="{{ cat.name }}" {% if cat.name == selected_category %}selected{% endif %}>{{ cat.name }}</option>
                  {% endfor %}
              </select>
            </div>
        </div>
        <div class="search-form-item">
            <input type="text" name="keyword" class="form-control" value="{{ keyword or '' }}" placeholder="キーワード">
        </div>
        <div class="search-form-item search-form-button">
            <button type="submit" class="btn btn-primary w-100">検索</button>
        </div>
      </div>

      <div class="search-form-row search-form-sort">
        <div class="search-form-item">
            <div class="custom-select-wrapper">
              <select name="sort" onchange="this.form.submit()" class="form-select custom-select-override">
                  <option value="name" {% if sort_by == 'name' %}selected{% endif %}>標準（名前順）</option>
                  <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>評価順</option>
              </select>
            </div>
        </div>
      </div>
    </form>

    <h2>検索結果</h2>
    {% for salon in salons %}
      <div class="salon-card">
        {# ▼▼▼▼▼ 名前の表示を修正 ▼▼▼▼▼ #}
        <h3><a href="{{ url_for('salon_detail', salon_id=salon.id) }}">{{ salon.name or salon.name_hpb or '(名称未登録)' }}</a></h3>
        <p class="salon-address">{{ salon.address }}</p>

        {# ▼▼▼▼▼ GoogleとHPBの評価を両方表示するように改修 ▼▼▼▼▼ #}
        <div class="ratings-container">
            
            {# --- Google評価 --- #}
            {% set google_summary = salon.review_summaries|selectattr('source_name', 'equalto', 'Google')|first %}
            {% if google_summary and google_summary.rating %}
            <div class="rating-display" title="Googleの評価 {{ '%.1f'|format(google_summary.rating) }}">
                <div class="rating-stars">
                    <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                    <div class="rating-stars-filled" style="width: {{ (google_summary.rating / 5) * 100 }}%;">
                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                    </div>
                </div>
                <span class="rating-score">{{ "%.1f"|format(google_summary.rating) }}</span>
                <span class="review-count">({{ google_summary.count or 'N/A' }})</span>
                <span class="source-badge google-badge">Google</span>
            </div>
            {% endif %}

            {# --- Hot Pepper評価 --- #}
            {% set hpb_summary = salon.review_summaries|selectattr('source_name', 'equalto', 'Hot Pepper')|first %}
            {% if hpb_summary and hpb_summary.rating %}
            <div class="rating-display" title="Hot Pepperの評価 {{ '%.1f'|format(hpb_summary.rating) }}">
                <div class="rating-stars">
                    <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                    <div class="rating-stars-filled" style="width: {{ (hpb_summary.rating / 5) * 100 }}%;">
                        <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                    </div>
                </div>
                <span class="rating-score">{{ "%.1f"|format(hpb_summary.rating) }}</span>
                <span class="review-count">({{ hpb_summary.count or 'N/A' }})</span>
                <span class="source-badge hpb-badge">Hot Pepper</span>
            </div>
            {% endif %}

        </div>
      </div>
    {% else %}
      <p>該当するサロンが見つかりませんでした。</p>
    {% endfor %}

    <div class="pagination">
      <div class="pagination-desktop">
        {% if pagination.has_prev %}<a href="{{ url_for('salon_search', page=pagination.prev_num, keyword=keyword, area=selected_area, category=selected_category.name, sort=sort_by) }}">&laquo; 前へ</a>{% endif %}
        {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=3) %}
            {% if p %}{% if p == pagination.page %}<a class="active" href="#">{{ p }}</a>{% else %}<a href="{{ url_for('salon_search', page=p, keyword=keyword, area=selected_area, category=selected_category, sort=sort_by) }}">{{ p }}</a>{% endif %}{% else %}<span class="ellipsis">…</span>{% endif %}
        {% endfor %}
        {% if pagination.has_next %}<a href="{{ url_for('salon_search', page=pagination.next_num, keyword=keyword, area=selected_area, category=selected_category.name, sort=by) }}">次へ &raquo;</a>{% endif %}
      </div>
      <div class="pagination-mobile">
        {% if pagination.has_prev %}<a href="{{ url_for('salon_search', page=pagination.prev_num, keyword=keyword, area=selected_area, category=selected_category.name, sort=sort_by) }}">&laquo; 前のページ</a>{% endif %}
        <span class="page-indicator">ページ {{ pagination.page }} / {{ pagination.pages }}</span>
        {% if pagination.has_next %}<a href="{{ url_for('salon_search', page=pagination.next_num, keyword=keyword, area=selected_area, category=selected_category.name, sort=sort_by) }}">次のページ &raquo;</a>{% endif %}
      </div>
    </div>

</div>
{% endblock %}
