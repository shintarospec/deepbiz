# DeepBiz - 企画・仕様書

**最終更新:** 2025年12月22日  
**バージョン:** 1.0  
**ステータス:** Phase 1（データ拡充）実行中

---

## 📋 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [システム構成](#システム構成)
3. [データモデル](#データモデル)
4. [機能仕様](#機能仕様)
5. [データ拡充計画](#データ拡充計画)
6. [今後の予定](#今後の予定)
7. [技術スタック](#技術スタック)

---

## 🎯 プロジェクト概要

### プロジェクト名
**DeepBiz** (旧: Salondb)

### コンセプト
Googleマップのビジネス情報を網羅的にDB化し、詳細な連絡先情報・評価データを提供する検索プラットフォーム

### ターゲット業界
- **Phase 1:** 美容クリニック（1,905件）
- **Phase 2以降:** 業界問わず全ビジネス

### 主要機能
1. ビジネス検索（名前・住所・エリア）
2. 詳細情報表示（連絡先・評価・レビュー）
3. Googleマップ連携（Place ID、CID）
4. データ品質管理

---

## 🏗️ システム構成

### インフラ
- **VPS:** さくらインターネット 133.167.116.58
- **OS:** Ubuntu 24.04
- **Webサーバー:** Nginx + Gunicorn
- **アプリケーション:** Flask (Python 3.12)
- **データベース:** SQLite (salon_data.db)

### デプロイ構成
```
/var/www/salon_app/
├── app.py              # メインアプリケーション
├── models.py           # データモデル
├── templates/          # HTMLテンプレート
├── scripts/            # データ拡充スクリプト
│   ├── scrape_website_contacts.py  # Phase 1C
│   ├── enrich_cid_from_embed.py    # Phase 1B
│   ├── data_cleansing.py           # クレンジング
│   └── extract_failed_clinics.py   # エラー抽出
├── salon_data.db       # SQLiteデータベース
└── venv/               # Python仮想環境
```

### URL構成
- メインサイト: `http://133.167.116.58/`
- 検索ページ: `/search`
- 詳細ページ: `/salon/<id>`

---

## 📊 データモデル

### 現在のモデル (v1.0)

#### Salon テーブル
| カラム | 型 | 説明 | 取得状況 |
|--------|-----|------|---------|
| `id` | Integer | 主キー | 1,905件 |
| `name` | String(255) | ビジネス名 | 100% |
| `address` | String(255) | 住所 | 100% |
| `place_id` | String(255) | Google Place ID | 1,722件 (90.4%) |
| `cid` | String(255) | Google CID | 466件 (24.5%) |
| `website_url` | String(500) | 公式サイト | 1,749件 (91.8%) |
| `phone` | String(255) | 電話番号 | 431件 (22.6%) |
| `email` | String(255) | メールアドレス | 118件 (6.2%) |
| `inquiry_url` | String(500) | 問い合わせページ | 242件 (12.7%) |

#### ReviewSummary テーブル
| カラム | 型 | 説明 |
|--------|-----|------|
| `id` | Integer | 主キー |
| `salon_id` | Integer | 外部キー (Salon) |
| `source_name` | String(50) | 評価元 (Google/トリビュー等) |
| `rating` | Float | 評価スコア |
| `count` | Integer | レビュー件数 |

### 今後の変更予定 (v2.0)

#### Biz テーブル（Salonから改名）
**新規フィールド:**
- `former_name` (String): 旧名称
- `is_closed` (Boolean): 閉院・閉鎖フラグ
- `industry` (String): 業種カテゴリ
- `data_quality_score` (Integer): データ完全性スコア (0-100)

**変更:**
- テーブル名: `salon` → `biz`
- モデル名: `Salon` → `Biz`
- URL: `/salon/<id>` → `/biz/<id>`

---

## ⚙️ 機能仕様

### 1. 検索機能
- **検索条件:**
  - キーワード（名前・住所部分一致）
  - エリア（都道府県・市区町村）
  - 評価フィルタ
- **結果表示:**
  - 一覧形式
  - Google評価・レビュー数表示
  - ページネーション

### 2. 詳細表示
- **基本情報:**
  - ビジネス名
  - 住所
  - 電話番号
  - メールアドレス
  - 公式サイトリンク
  - 問い合わせページリンク
- **評価情報:**
  - Google評価
  - トリビュー評価
  - レビュー件数
- **マップ連携:**
  - Googleマップ埋め込み
  - 直リンク（CID使用）

### 3. データ管理機能（管理画面）
- データ完全性チェック
- エラー発生ビジネスの一覧
- CSV出力
- 手動データ編集

---

## 🚀 データ拡充計画

### データ拡充戦略

DeepBizは**段階的データ深掘り戦略**を採用し、コスト・精度・信頼性のバランスを最適化します。

```
【データ取得の優先順位】

Level 0: 元データ（CSV）
  ↓ 基本情報のみ、精度不明
  
Level 1: Google Maps（公式API）
  ↓ 高精度、位置情報・評価取得、コスト：中
  
Level 2: 公式サイト（スクレイピング）
  ↓ 詳細連絡先、コスト：低、精度：高
  
Level 3: 外部レビューサイト（API/スクレイピング）
  ↓ 多角的評価、コスト：低〜中、精度：中
  
Level 4: SNS・ニュース（将来）
  ↓ リアルタイム情報、評判分析
```

### なぜこの順番？

1. **Google Maps優先**
   - 理由: 最も信頼性が高く、Place ID取得で後続処理が可能になる
   - コスト: $32/1000件（許容範囲）
   - 結果: 90.4%成功 → 基盤として十分

2. **公式サイト第2優先**
   - 理由: 最新・正確な連絡先情報
   - コスト: $0（Selenium）
   - 課題: SSL証明書エラー、閉鎖サイト
   - 対策: エラー自動スキップ、後で手動補完

3. **外部サイトは後回し**
   - 理由: データ精度にばらつきがある
   - 実装: 公式情報が確立した後に追加

### Phase 0: 基本データ取得 ✅ 完了
- **期間:** 2025年12月21日
- **内容:** CSVインポート + Google Maps API
- **結果:** 1,905件、Place ID 90.4%取得

### Phase 1A: Place ID取得 ✅ 完了
- **API:** Google Maps Text Search API
- **コスト:** $55
- **結果:** 1,722件 Place ID取得

### Phase 1B: CID取得 🔄 実行予定
- **方式:** Selenium + Google Maps URL解析
- **対象:** 1,256件（Place IDあり、CIDなし）
- **予想時間:** 3-4時間
- **コスト:** $0
- **ステータス:** Phase 1C完了後に実行
- **方法:**
  ```python
  # URL: https://www.google.com/maps/search/?api=1&query_place_id={place_id}
  # 抽出: !1s0x[hex]:0x[hex] → 10進数変換
  ```
- **成功率:** テスト 5/5件 (100%)

### Phase 1C: 連絡先情報取得 🔄 実行中
- **方式:** Selenium + 公式サイトスクレイピング
- **対象:** 1,506件（未処理分）
- **取得内容:**
  - 電話番号
  - メールアドレス
  - 問い合わせページURL
- **進捗:** 24/1,506件 (1.6%)
- **予想完了:** 2025年12月23日 午前9時
- **成功率:** 
  - 電話番号: 100%
  - 問い合わせページ: 56%
  - メール: 27%
- **特徴:**
  - 30件ごとブラウザ再起動（メモリリーク対策）
  - エラー時自動復旧
  - SSLエラー自動スキップ

---

## 📅 今後の予定

### 2025年12月23日（明日）

#### 午前9時: Phase 1C完了
- 連絡先情報 約1,500件追加

#### 午前9時〜午後1時: Phase 1B実行
- CID 約1,256件取得
- 完了予定: 午後1時

#### 午後1時〜2時: データクレンジング
**実行内容:**
1. 電話番号の正規化
   - 複数番号 → 代表1つに統一
   - フォーマット統一 (`03-1234-5678`)
   - 不正番号の除外

2. 住所の統一
   - 郵便番号削除（91%に含まれる）
   - 形式統一

3. 名前情報の整理
   - 旧名称の抽出・分離
   - 閉院フラグの設定

4. メールアドレスの整理
   - 複数メール → 代表1つ

**スクリプト:** `scripts/data_cleansing.py`

#### 午後2時〜3時: Salon→Biz移行
**実行内容:**
1. テーブル名変更: `salon` → `biz`
2. モデル変更: `Salon` → `Biz`
3. URL変更: `/salon/` → `/biz/`
4. UI表示変更: 「クリニック」→「ビジネス」
5. 新フィールド追加:
   - `former_name`
   - `is_closed`
   - `industry`
   - `data_quality_score`

### 2025年12月24日〜26日

#### DeepBiz API開発（2-3日）
**目的:** 外部システム連携の基盤構築

**実装内容:**
1. REST API実装
   - `GET /api/biz` - ビジネスリスト取得
   - `GET /api/biz/:id` - ビジネス詳細取得
   - `POST /api/biz/batch` - バッチ取得
   - `GET /api/health` - ヘルスチェック

2. 認証・セキュリティ
   - API Key認証
   - CORS設定
   - レート制限

3. ドキュメント
   - API仕様書
   - 使用例
   - エラーコード一覧

**成果物:**
- `/api/biz` エンドポイント稼働
- API仕様書完成
- テスト完了

### 2025年12月27日〜31日

#### SQLite → PostgreSQL移行（1-2日）
**理由:** スケーラビリティ・同時接続数の向上

**実行内容:**
1. PostgreSQLセットアップ
2. スキーマ移行
3. データ移行（1,905件）
4. 接続テスト
5. パフォーマンス検証

**成果物:**
- PostgreSQL本番稼働
- バックアップ体制確立

#### データ品質ダッシュボード実装（1日）
**機能:**
- データ完全性スコア表示
- エラー発生ビジネス一覧
- CSV出力機能
- フィルタ・ソート機能

#### 検索機能強化（1日）
**追加機能:**
- 業種別フィルタ
- 評価フィルタ
- エリア検索（都道府県・市区町村）
- ソート機能（評価順・新着順）

### Phase 2以降（2025年12月24日〜）

#### 2026年1月1日〜7日: Phase 2A-1 外部システム連携（第1弾）

**プロジェクト:** AI Auto Form連携（営業自動化システム）

**目的:** DeepBizをデータインフラとして活用する第1号事例

**システム構成:**
```
DeepBiz (VPS-1)              Worker System (VPS-2)
├─ PostgreSQL (企業DB)       ├─ PostgreSQL (タスクDB)
├─ REST API                  ├─ DeepBizClient
│  └─ /api/biz              ├─ Playwright自動化
└─ データ提供                └─ 問い合わせフォーム送信
```

**実装タスク:**

1. **DeepBiz側準備（2日）**
   - [ ] API認証キー発行
   - [ ] Worker用API Key生成
   - [ ] IP制限設定（Worker VPSのみ許可）
   - [ ] API使用量ロギング
   - [ ] ドキュメント整備

2. **Worker側実装（2日）**
   - [ ] DeepBizClient実装
   - [ ] キャッシュ機構（1日1回更新）
   - [ ] エラーハンドリング
   - [ ] データマッピング
     - `biz.name` → `company.name`
     - `biz.inquiry_url` → `company.form_url`
     - `biz.website_url` → `company.website_url`

3. **統合テスト（1日）**
   - [ ] Codespaces環境でのテスト
   - [ ] モックモード動作確認
   - [ ] エラーシナリオテスト
   - [ ] パフォーマンステスト

4. **VPS展開（2日）**
   - [ ] VPS 2台契約（各4GB）
   - [ ] プライベートネットワーク設定
   - [ ] 両VPSデプロイ
   - [ ] 本番環境統合テスト
   - [ ] 監視設定

**成果物:**
- DeepBiz API稼働（認証付き）
- Worker System稼働
- 統合ドキュメント完成
- 1,905件のビジネスデータが自動営業に活用可能

**収益モデル:**
- API利用料: 月額$99-499
- または: レベニューシェア（成約ベース）

**評価指標:**
- API リクエスト数/日
- Worker側の成功率
- システム稼働率

---

#### 2026年1月8日〜14日: Phase 2A-2 外部レビューサイト連携
**データソース:**
- トリビュー（既に一部実装）
- ホットペッパービューティー
- その他美容系レビューサイト

**取得内容:**
- 評価スコア
- レビュー件数
- カテゴリ情報

**方式:** API連携 or スクレイピング

#### Phase 2B: SNS情報取得
**データソース:**
- Instagram（ビジネスアカウント）
- Twitter/X
- Facebook ページ

**取得内容:**
- フォロワー数
- 投稿頻度
- エンゲージメント率

#### Phase 2C: ニュース・メディア情報
**データソース:**
- Google News API
- 業界メディア

**取得内容:**
- 掲載記事
- PR情報
- トレンド分析

---

### データ拡充のロードマップ

```
Phase 0: 元データ ──────────────── ✅ 完了
         └→ CSV 1,905件

Phase 1: Google Maps ─────────────  🔄 実行中
         ├→ 1A: Place ID (90.4%) ─── ✅ 完了
         ├→ 1B: CID (予定)      ───  ⏳ 待機
         └→ 1C: 公式サイト (実行中) ─ 🔄 1.6%

Phase 2: 外部サイト ─────────────  📅 予定
         ├→ 2A: レビューサイト
         ├→ 2B: SNS
         └→ 2C: ニュース

Phase 3: リアルタイム更新 ────────  💭 構想
         └→ 定期自動更新
```

---

#### データ品質管理機能
- データ完全性ダッシュボード
- エラー発生ビジネスCSV出力
- 手動データ補完機能

#### 業界拡大
- 美容クリニック以外のカテゴリ追加
- 業種別検索機能
- カテゴリマスタ管理

#### 機能拡張
- お気に入り機能
- レビュー詳細表示
- データエクスポート（CSV/JSON API）

---

## 💻 技術スタック

### バックエンド
- **言語:** Python 3.12
- **フレームワーク:** Flask 3.0
- **ORM:** SQLAlchemy
- **DB:** SQLite (production), PostgreSQL (検討中)

### フロントエンド
- **テンプレート:** Jinja2
- **CSS:** カスタムCSS
- **JavaScript:** Vanilla JS

### データ収集
- **Google Maps API:**
  - Text Search API
  - Place Details API
- **スクレイピング:**
  - Selenium WebDriver
  - undetected-chromedriver
  - BeautifulSoup4

### インフラ
- **Webサーバー:** Nginx 1.24
- **WSGI:** Gunicorn
- **プロセス管理:** systemd
- **バックグラウンド実行:** GNU Screen

### 開発環境
- **IDE:** VS Code (GitHub Codespaces)
- **バージョン管理:** Git / GitHub
- **SSH:** sshpass経由デプロイ

---
## 🔌 エコシステム展開計画

### DeepBizをデータインフラとして活用

```
                    DeepBiz Core
                    (企業DB・API)
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    🤖 Worker       📊 BI Tools    🔗 CRM/MA
    自動営業        データ分析      顧客管理
         │               │               │
    問い合わせ      市場調査      リード管理
    フォーム送信    競合分析      セールス
```

### 連携プロジェクト一覧

#### 第1弾: AI Auto Form（営業自動化）✅ 2026年1月
- **ステータス:** 統合ガイド作成済み
- **価値:** 自動営業でリード獲得
- **収益:** API利用料 or レベニューシェア

#### 第2弾: BI ダッシュボード 📅 2026年Q2
- **機能:** 市場分析・競合分析
- **対象:** コンサル・投資家
- **収益:** サブスクリプション

#### 第3弾: CRM統合 📅 2026年Q3
- **連携先:** Salesforce, HubSpot
- **機能:** 企業情報の自動補完
- **収益:** API利用料

#### 第4弾: コールセンターシステム 📅 2026年Q4
- **機能:** 架電リスト提供
- **データ:** 電話番号・営業時間
- **収益:** リード販売

---
## 📈 データ統計（2025年12月22日 23:00時点）

### 総ビジネス数: 1,905件

### データ取得状況
| 項目 | 件数 | 割合 |
|------|------|------|
| Place ID | 1,722 | 90.4% |
| CID | 466 | 24.5% |
| 公式サイト | 1,749 | 91.8% |
| 電話番号 | 431 | 22.6% |
| メールアドレス | 118 | 6.2% |
| 問い合わせページ | 242 | 12.7% |
| Google評価 | 1,722 | 90.4% |

### Phase 1完了後の予想
| 項目 | 予想件数 | 予想割合 |
|------|---------|---------|
| Place ID | 1,722 | 90.4% |
| CID | 1,722 | 90.4% |
| 公式サイト | 1,749 | 91.8% |
| 電話番号 | 1,900+ | 99%+ |
| メールアドレス | 600+ | 31%+ |
| 問い合わせページ | 1,200+ | 63%+ |

---

## 🔐 セキュリティ・制約事項

### API制限
- **Google Maps API:**
  - 月間$200無料枠
  - Text Search: $32/1000件
  - 現在使用: $55

### スクレイピングポリシー
- `robots.txt` 遵守
- User-Agent設定
- レート制限: 2-3秒/リクエスト
- 負荷分散: 30件ごとブラウザ再起動

### データプライバシー
- 公開情報のみ収集
- 個人情報（口コミ投稿者名等）は収集しない

---

## 📝 用語集

| 用語 | 説明 |
|------|------|
| **Biz** | ビジネス（店舗・施設）の総称。旧「Salon」 |
| **Place ID** | GoogleマップのビジネスID（文字列） |
| **CID** | GoogleマップのビジネスID（数値）、直リンク用 |
| **データクレンジング** | データの正規化・標準化・品質向上作業 |
| **DRY RUN** | 実際の変更を伴わないテスト実行 |

---

## 🤝 開発体制

- **プロジェクトオーナー:** @shintarospec
- **開発環境:** GitHub Codespaces
- **リポジトリ:** github.com/shintarospec/deepbiz

---

## 📞 問い合わせ

プロジェクトに関する質問・提案は GitHub Issues へ。

---

**Document Version:** 1.0  
**Last Updated:** 2025-12-22 23:00 JST
